if("undefined"===typeof bu||"undefined"===typeof bu.plugins.navigation||"undefined"===typeof bu.plugins.navigation.tree)throw new TypeError("BU Navigation Manager script dependencies have not been met!");
(function(b){var r=bu.plugins.navigation;r.trees.buse_perm_editor=function(l,k){var k=k||{},p=r.trees.base(l,k),m=p.data,g=b.extend(p.config,l||{});m.treeConfig.types={types:{"default":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-60px 0"}},denied:{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-60px 0"}},"denied-desc-allowed":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"2px 0"}},"denied-desc-unknown":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",
position:"-100px 0"}},allowed:{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-40px 0"}},"allowed-desc-denied":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-20px 0"}},"allowed-desc-unknown":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-120px 0"}}}};m.treeConfig.ui={select_limit:1};m.treeConfig.json_data.ajax={url:g.rpcUrl,type:"GET",cache:!1,data:function(b){return{group_id:g.groupID,node_prefix:g.nodePrefix,post_type:g.postType,query:{child_of:b.attr?
k.stripNodePrefix(b.attr("id")):0}}},success:function(b){return b.posts},error:function(){}};return p}})(jQuery);
jQuery(document).ready(function(b){var r=bu.plugins.navigation,l=b("#group-member-list");b("a.nav-link").click(function(a){a.preventDefault();var a=b("a.nav-tab[href="+this.hash+"]"),c=b(this.hash);$input=c.hasClass("group-panel")?b("#tab"):b("#perm_panel");$input.val(a.data("target"));a.addClass("nav-tab-active").siblings().removeClass("nav-tab-active");c.addClass("active").siblings().removeClass("active")});b("#edit-group-name").blur(function(){var a=b.trim(b(this).val());60<a.length&&(a=a.slice(0,
59),b(this).val(a));if(1>a.length)return q("Section editing groups require a name."),!1;y();b("#group-stats-name").html(a)});b(".member:not(.active)").appendTo("#inactive-members");l.delegate("a.remove_member","click",function(a){a.preventDefault();b(this).parent(".member").removeClass("active").slideUp("fast",function(){b(this).appendTo("#inactive-members").find('input[type="checkbox"]').removeAttr("checked");g()})});var k=function(a){var c=b.map(b('li.member.active input[type="checkbox"]'),function(b){return b.value});
return-1<b.inArray(a.id,c)},p=b(".buse-suggest-user").autocomplete({source:function(a,c){var d,e=a.term;d=b.grep(buse_site_users,function(b){e=e.toLowerCase();return b.user.is_section_editor&&(-1!=b.user.display_name.toLowerCase().indexOf(e)||-1!=b.user.login.toLowerCase().indexOf(e)||-1!=b.user.nicename.toLowerCase().indexOf(e)||-1!=b.user.email.toLowerCase().indexOf(e))});d=b.grep(d,function(b){return!k(b.user)});d=b.map(d,function(b){return b.autocomplete});c(d)},delay:500,minLength:2,position:"undefined"!==
typeof isRtl&&isRtl?{my:"right top",at:"right bottom",offset:"0, -1"}:{offset:"0, -1"},open:function(){b(this).addClass("open")},close:function(){b(this).removeClass("open")}});b("#add_member").bind("click",function(b){b.preventDefault();m()});b("#user_login").keypress(function(b){"13"==b.keyCode&&(b.preventDefault(),m())});var m=function(){var a=b.trim(b("#user_login").val());if(a){p.autocomplete("search","");var c;c=b.grep(buse_site_users,function(b){var c=a.toLowerCase();return b.user.display_name.toLowerCase()==
c||b.user.login.toLowerCase()==c||b.user.nicename.toLowerCase()==c||b.user.email.toLowerCase()==c});c=1<c.length||0==c.length?!1:c[0].user;var d=buse_group_editor_settings.usersUrl;c?c.is_section_editor?k(c)?(c="<b>"+c.display_name+"</b> is already a member of this group.",q(c,"members-message")):(y("members-message"),b("#member_"+c.id).attr("checked","checked").parent(".member").addClass("active").appendTo(l).slideDown("fast"),g()):(d+="?s="+c.login,c="<b>"+c.display_name+'</b> is not a section editor.  Before you can assign them to a group, you must change their role to "Section Editor" on the <a href="'+
d+'">users page</a>.',q(c,"members-message")):(d=buse_group_editor_settings.userNewUrl,q("<b>"+a+'</b> is not a member of this site.  Please <a href="'+d+'">add them to your site</a> with the "Section Editor" role.',"members-message"))}b("#user_login").val("").focus()},g=function(){var a=l.children(".member").length;b(".member-count").html(a)},x=function(a){var c=a.find(".perm-editor").first();if(c.hasClass("hierarchical")){var d={el:"#"+c.attr("id"),groupID:b("#group_id").val()||-1,postType:c.data("post-type")};
b.extend(d,buse_group_editor_settings);r.tree("buse_perm_editor",d);c.bind("load_node.jstree",function(b,c){-1!=c.rslt.obj&&z(c.rslt.obj)}).bind("select_node.jstree",function(b,a){a.inst.is_selected(a.rslt.obj)&&A(a.rslt.obj,c)}).bind("deselect_node.jstree",function(){n(c)}).bind("deselect_all.jstree",function(){n(c)}).bind("overlay_clicked.buse",function(){c.jstree("get_selected").each(function(){var a=b(this),d=B(a);u(d,b(this),c);c.jstree("deselect_node",a)})})}else d=c.data("post-type"),c.delegate("a",
"click",function(a){a.preventDefault();a.stopPropagation();a=b(this).parent("li").first();a.siblings("li.perm-item-selected").each(function(){b(this).removeClass("perm-item-selected");c.trigger("deselect_post.buse",{post:b(this)})});a.addClass("perm-item-selected");c.trigger("select_post.buse",{post:a})}),c.closest(".perm-panel").bind("click",function(){c.trigger("deselect_all.buse")}),c.bind("posts_loaded.buse",function(){var a=b(this).siblings("input.buse-edits").first();if(0!==a.val().length)for(post_id in a=
JSON.parse(a.val()),a){var d=c.find("#p"+post_id);d.length&&d.attr("rel",a[post_id])}}).bind("select_post.buse",function(b,a){A(a.post,c)}).bind("deselect_all.buse",function(){n(c)}).bind("overlay_clicked.buse",function(){c.find(".perm-item-selected").each(function(){var a=b(this),d=B(a);u(d,a,c);b(this).removeClass("perm-item-selected")})}),v(c,{post_type:d});a.delegate("button.perm-search","click",function(a){a.preventDefault();a=c.data("post-type");a=b("#perm-search-"+a).val();a={post_type:c.data("post-type"),
query:{s:a}};n(c);v(c,a)});a.find(".pagination-links").delegate("a","click",function(a){a.preventDefault();if(!b(this).hasClass("disabled")){var a=b(this).attr("class"),d=parseInt(b(this).parent().find(".current-page").val()),h=parseInt(b(this).parent().find(".total-pages").text()),i=1;switch(a){case "first-page":i=1;break;case "prev-page":i=d-1;break;case "next-page":i=d+1;break;case "last-page":i=h}C(i,c)}});a.delegate("input.current-page","keypress",function(a){if("13"==a.keyCode){a.preventDefault();
var a=b(this).val(),d=parseInt(b(this).parent().find(".total-pages").text());1>a?b(this).val(1):a>d&&b(this).val(d);a=b(this).val();C(a,c)}});a.delegate("input.perm-search","keypress",function(a){13==a.keyCode&&(a.preventDefault(),b(this).siblings("button").first().click())});a.delegate("a.perm-editor-bulk-edit","click",function(b){b.preventDefault();a.addClass("bulk-edit")});a.delegate("a.bulk-edit-close","click",function(b){b.preventDefault();a.removeClass("bulk-edit")});a.delegate(".bulk-edit-select-all",
"click",function(){c.find('input[type="checkbox"]').attr("checked",this.checked)});a.delegate(".bulk-edit-actions button","click",function(d){d.preventDefault();var d=b(this).siblings("select"),f=d.val(),h=c.find('input[type="checkbox"]:checked');0<h.length&&("allowed"==f||"denied"==f)&&h.each(function(){var a=b(this).parents("li");a.attr("rel",f);u(f,a,c)});a.find(".bulk-edit-select-all").attr("checked",!1);d.val("none");h.attr("checked",!1)});a.delegate("a.perm-tree-expand","click",function(a){a.preventDefault();
b.jstree._reference(c).open_all()});a.delegate("a.perm-tree-collapse","click",function(a){a.preventDefault();b.jstree._reference(c).close_all()});b('<span class="buse-overlay inactive"></span>').html('<a href="#" class="buse-action"><ins class="buse-icon">&nbsp;</ins></a>').insertAfter(c).delegate(".buse-action","click",function(a){a.stopPropagation();a.preventDefault();n(c);c.trigger("overlay_clicked.buse")});a.addClass("loaded")};b("#perm-tab-container").delegate("a","click",function(){var a=b(b(this).attr("href"));
a.hasClass("loaded")||x(a)});var C=function(a,c){var d=c.closest(".perm-panel"),e=c.data("post-type"),f={post_type:e,query:{paged:a}},e=b("#perm-search-"+e).val();0<e.length&&(f.query.s=e);n(c);d.find(".bulk-edit-select-all").attr("checked",!1);d.find(".bulk-edit-actions select").val("none");v(c,f)},F={allowed:{label:"Deny Editing","class":"allowed"},"allowed-desc-denied":{label:"Deny Editing","class":"allowed"},"allowed-desc-unknown":{label:"Deny Editing","class":"allowed"},denied:{label:"Allow Editing",
"class":"denied"},"denied-desc-allowed":{label:"Allow Editing","class":"denied"},"denied-desc-unknown":{label:"Allow Editing","class":"denied"}},A=function(a,c){var d=a.attr("rel"),e=a.children("a:first").first(),f=b("#perm-panel-container"),h=c.siblings(".buse-overlay").first(),d=F[d];"undefined"!=typeof d&&(e={of:e,my:"left center",at:"right center",within:f,offset:"15 0",collision:"fit none"},h.find(".buse-action").html('<ins class="buse-icon">&nbsp;</ins> '+d.label),h.removeClass("inactive allowed allowed-desc-denied denied denied-desc-allowed").addClass(d["class"]).position(e))},
n=function(a){a.siblings(".buse-overlay").removeClass("allowed allowed-desc-denied denied denied-desc-allowed").addClass("inactive")[0].removeAttribute("style")},v=function(a,c){var d={action:"buse_render_post_list",group_id:b("#group_id").val()||-1,query:{}};void 0!==typeof c&&b.extend(d,c);a.addClass("loading");d.query.offset?a.append('<span class="loader">Loading...</span>'):a.html('<span class="loader">Loading...</span>');b.ajax({url:ajaxurl,type:"GET",data:d,cache:!1,success:function(c){d.query.offset?
a.append(c.posts):a.html(c.posts);var f=c.page,h=c.found_posts,g=c.max_num_pages,j=a.data("post-type");b("#group_id").val();$pagination=b("#perm-editor-pagination-"+j);$total_items=$pagination.find(".displaying-num");$current_page=$pagination.find(".current-page");$total_pages=$pagination.find(".total-pages");$first_page=$pagination.find(".first-page");$prev_page=$pagination.find(".prev-page");$next_page=$pagination.find(".next-page");$last_page=$pagination.find(".last-page");j=1==parseInt(h)?" item":
" items";$total_items.text(h+j);$current_page.val(f);$total_pages.text(g);1==f?($first_page.addClass("disabled"),$prev_page.addClass("disabled")):($first_page.removeClass("disabled"),$prev_page.removeClass("disabled"));f==g?($next_page.addClass("disabled"),$last_page.addClass("disabled")):($next_page.removeClass("disabled"),$last_page.removeClass("disabled"));a.trigger("posts_loaded.buse",{posts:c.posts});a.removeClass("loading")},error:function(){}})},u=function(a,c,d){c.attr("rel",a);if(d.hasClass("hierarchical")){var e=
b.jstree._reference(d);c.hasClass("jstree-closed")?e.open_node(c,function(){e.open_all(c);w(a,c,d)}):w(a,c,d)}d.hasClass("flat")&&w(a,c,d)},B=function(a){a=a.data("perm");return"allowed"==a?"denied":"denied"==a?"allowed":"denied"},w=function(a,c,d){var e=c.attr("id").substr(1),f=d.data("post-type"),g,i=b("#buse-edits-"+f).val()||"";g=i?JSON.parse(i):{};var j=0;prev_state=c.data("perm");c.data("perm",a);g[e]=a;prev_state!=a&&(j="allowed"==a?j+1:j-1);d.hasClass("hierarchical")&&(c.find("li").each(function(c,
d){var e=b(d).data("perm"),f=b(this).attr("id").substr(1);e!=a&&(b(d).data("perm",a),g[f]=a,j="allowed"==a?j+1:j-1);b(d).attr("rel",a)}),$root_post=c.parentsUntil("#"+d.attr("id"),"li").last(),$root_post.length&&z($root_post));b("#buse-edits-"+f).val(JSON.stringify(g));d=j;b("#group-stats-permissions");e=b("#"+f+"-stats");c=b("#"+f+"-pending-diff");i=0;0==c.length&&(c=b('<span id="'+f+'-pending-diff" class="perm-stats-diff" data-count="0"></span>').appendTo(e));i=parseInt(c.data("count"));f=i+d;d=
"";0<f?(d=" ( +"+f+" )",c.removeClass("negative").addClass("positive")):0>f?(d=" ( "+f+" )",c.removeClass("positive").addClass("negative")):c.removeClass("positive negative");c.data("count",f).text(d)},z=function(a){$sections=a.find("ul");$sections.each(function(){var a=b(this).parents("li").first();if(a.length){var d=!1;switch(a.attr("rel")){case "allowed":case "allowed-desc-denied":case "allowed-desc-unknown":(d=0<b(this).find('li[rel="denied"],li[rel="denied-desc-allowed"],li[rel="denied-desc-unknown"]').length)?
a.attr("rel","allowed-desc-denied"):a.attr("rel","allowed");break;case "denied":case "denied-desc-allowed":case "denied-desc-unknown":(d=0<b(this).find('li[rel="allowed"],li[rel="allowed-desc-denied"],li[rel="allowed-desc-unknown"]').length)?a.attr("rel","denied-desc-allowed"):a.attr("rel","denied")}}})},q=function(a,c,d){var e={classes:"error",before_msg:"<p>",after_msg:"</p>"};d&&"object"==typeof d&&b.extend(e,d);b("#"+(c||"message")).attr("class",e.classes).html(e.before_msg+a+e.after_msg).fadeIn()},
y=function(a){b("#"+(a||"message")).fadeOut("fast",function(){b(this).attr("class","").html("")})},D,s;D=b("#edit-group-name").val();var E=function(){var a=[];b("#group-member-list").children("li.member.active").each(function(c,d){a.push(b(d).children("input").first().val())});return a};s=E();window.onbeforeunload=function(){if(G())return"Your group has pending edits.  If you leave now, your changes will be lost."};var G=function(){if(D!=b("#edit-group-name").val())return!0;var a=E();if(s.length!=
a.length)return!0;for(index in s)if(-1==b.inArray(s[index],a))return!0;var c=!1;b(".buse-edits").each(function(a,e){b(e).val()&&(c=!0)});return c};b("#group-edit-form").submit(function(){window.onbeforeunload=null;if(1>b.trim(b("#edit-group-name").val()).length)return q("Section editing groups require a name."),!1});b("a.submitdelete").click(function(a){a.preventDefault();confirm("You are about to permanently delete this section editing group.  This action is irreversible.\n\nAre you sure you want to do this?")&&
(window.onbeforeunload=null,window.location=b(this).attr("href"))});if(document.images){var t=new Image,H=new Image;t.src=buse_group_editor_settings.pluginUrl+"/images/group_perms_sprite.png";H.src=buse_group_editor_settings.pluginUrl+"/images/loading.gif"}t=b("#perm-panel-container").find(".perm-panel.active").first();t.length&&x(t);b("div#message").insertAfter(b("div.wrap h2:first"))});