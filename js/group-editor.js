jQuery(document).ready(function(e){var t;typeof bu!="undefined"&&typeof bu.plugins.navigation!="undefined"&&typeof bu.plugins.navigation.tree!="undefined"&&(t=bu.plugins.navigation);var n=e("#group-member-list"),r=e("a.nav-link");r.click(function(t){t.preventDefault();var n=e("a.nav-tab[href="+this.hash+"]"),r=e(this.hash);$input=r.hasClass("group-panel")?e("#tab"):e("#perm_panel");$input.val(n.data("target"));n.addClass("nav-tab-active").siblings().removeClass("nav-tab-active");r.addClass("active").siblings().removeClass("active")});var i=60;e("#edit-group-name").blur(function(t){var n=e.trim(e(this).val());if(n.length>i){n=n.slice(0,i-1);e(this).val(n)}if(n.length<1){L("Section editing groups require a name.");return!1}A();e("#group-stats-name").html(n)});e(".member:not(.active)").appendTo("#inactive-members");n.delegate("a.remove_member","click",function(t){t.preventDefault();e(this).parent(".member").removeClass("active").slideUp("fast",function(){e(this).appendTo("#inactive-members").find('input[type="checkbox"]').removeAttr("checked");p()})});var s=function(){return e.map(e('li.member.active input[type="checkbox"]'),function(e){return parseInt(e.value,10)})},o=function(t,n){return e.grep(t,function(e,t){n=n.toLowerCase();return e.user.is_section_editor&&(e.user.display_name.toLowerCase().indexOf(n)!=-1||e.user.login.toLowerCase().indexOf(n)!=-1||e.user.nicename.toLowerCase().indexOf(n)!=-1||e.user.email.toLowerCase().indexOf(n)!=-1)})},u=function(t){return e.grep(t,function(e,t){return!a(e.user)})},a=function(t){var n=s();return e.inArray(t.id,n)>-1},f=function(t){var n=e.grep(buse_site_users,function(e,n){var r=t.toLowerCase();return e.user.display_name.toLowerCase()==r||e.user.login.toLowerCase()==r||e.user.nicename.toLowerCase()==r||e.user.email.toLowerCase()==r});return n.length>1||n.length==0?!1:n[0].user},l=e(".buse-suggest-user").autocomplete({source:function(t,n){var r=o(buse_site_users,t.term),r=u(r),i=e.map(r,function(e){return e.autocomplete});n(i)},delay:500,minLength:2,position:"undefined"!=typeof isRtl&&isRtl?{my:"right top",at:"right bottom",offset:"0, -1"}:{offset:"0, -1"},open:function(){e(this).addClass("open")},close:function(){e(this).removeClass("open")}});e("#add_member").bind("click",function(e){e.preventDefault();c()});e("#user_login").keypress(function(e){if(e.keyCode=="13"){e.preventDefault();c()}});var c=function(){var t=e.trim(e("#user_login").val());if(t){l.autocomplete("search","");var n=f(t),r=buse_group_editor_settings.usersUrl;if(n)if(!n.is_section_editor){r+="?s="+n.login;var i="<b>"+n.display_name+'</b> is not a section editor.  Before you can assign them to a group, you must change their role to "Section Editor" on the <a href="'+r+'">users page</a>.';L(i,"members-message")}else if(a(n)){var i="<b>"+n.display_name+"</b> is already a member of this group.";L(i,"members-message")}else{A("members-message");h(n)}else{r=buse_group_editor_settings.userNewUrl;var i="<b>"+t+'</b> is not a member of this site.  Please <a href="'+r+'">add them to your site</a> with the "Section Editor" role.';L(i,"members-message")}}e("#user_login").val("").focus()},h=function(t){e("#member_"+t.id).attr("checked","checked").parent(".member").addClass("active").appendTo(n).slideDown("fast");p()},p=function(){var t=n.children(".member").length;e(".member-count").html(t)},d=function(n){var r=n.find(".perm-editor").first();if(r.hasClass("hierarchical"))if(typeof t=="undefined"){alert("Warning: Hierarchical permission editors require the BU Navigation plugin.");r.text("Please install the BU Navigation plugin in order to set permissions for post type: "+r.data("post-type"))}else w(r);else y(r);v(n,r);r.delegate(".edit-perms","click",function(t){var n=e(t.currentTarget),i=n.closest("li"),s=n.attr("class"),o,u;t.stopPropagation();t.preventDefault();s.indexOf("allowed")>-1?o="allowed":s.indexOf("denied")>-1&&(o="denied");u=o=="allowed"?!0:!1;x(i,u,r);r.trigger("perm_updated",[{post:i,action:o}])});e(document).bind("click",function(t){var n=e(".perm-panel.active"),r=e(".perm-editor",n),i=e.contains(n[0],t.target);i||(r.hasClass("hierarchical")&&typeof r.jstree!="undefined"?r.jstree("deselect_all"):r.find(".perm-item-selected").removeClass("perm-item-selected"))});n.addClass("loaded")};e("#perm-tab-container").delegate("a","click",function(t){var n=e(e(this).attr("href"));n.hasClass("loaded")||d(n)});var v=function(t,n){t.delegate("button.perm-search","click",function(t){t.preventDefault();var r=n.data("post-type"),i=e("#perm-search-"+r).val(),s={post_type:n.data("post-type"),query:{s:i}};E(n,s)});t.find(".pagination-links").delegate("a","click",function(t){t.preventDefault();if(e(this).hasClass("disabled"))return;var r=e(this).attr("class"),i=parseInt(e(this).parent().find(".current-page").val()),s=parseInt(e(this).parent().find(".total-pages").text()),o=1;switch(r){case"first-page":o=1;break;case"prev-page":o=i-1;break;case"next-page":o=i+1;break;case"last-page":o=s}m(o,n)});t.delegate("input.current-page","keypress",function(t){if(t.keyCode=="13"){t.preventDefault();var r=e(this).val(),i=parseInt(e(this).parent().find(".total-pages").text());r<1?e(this).val(1):r>i&&e(this).val(i);r=e(this).val();m(r,n)}});t.delegate("input.perm-search","keypress",function(t){if(t.keyCode==13){t.preventDefault();e(this).siblings("button").first().click()}});t.delegate("a.perm-editor-bulk-edit","click",function(r){r.preventDefault();var i=e(this);if(t.hasClass("bulk-edit")){i.removeClass("bulk-edit-close").attr("title","Enable bulk edit mode").text("Bulk Edit");t.removeClass("bulk-edit")}else{i.addClass("bulk-edit-close").attr("title","Disable bulk edit mode").text("Close Bulk Edit");t.addClass("bulk-edit")}n.find(".perm-item-selected").removeClass("perm-item-selected");t.find('input[type="checkbox"]').attr("checked",!1);e(".bulk-edit-actions select").val("none")});t.delegate(".bulk-edit-select-all","click",function(e){var t=n.find("li");t.children('input[type="checkbox"]').attr("checked",this.checked)});t.delegate(".bulk-edit-actions button","click",function(r){r.preventDefault();var i=e(this).siblings("select"),s=i.val(),o=n.find('input[type="checkbox"]:checked');o.length>0&&(s=="allowed"||s=="denied")&&o.each(function(){var t=e(this).parents("li"),r=s=="allowed"?!0:!1;x(t,r,n)});t.find(".bulk-edit-select-all").attr("checked",!1);i.val("none");o.attr("checked",!1)});t.delegate("a.perm-tree-expand","click",function(t){t.preventDefault();typeof e.jstree!="undefined"&&e.jstree._reference(n).open_all()});t.delegate("a.perm-tree-collapse","click",function(t){t.preventDefault();typeof e.jstree!="undefined"&&e.jstree._reference(n).close_all()})},m=function(t,n){var r=n.closest(".perm-panel"),i=n.data("post-type"),s={post_type:i,query:{paged:t}},o=e("#perm-search-"+i).val();o.length>0&&(s.query.s=o);r.find(".bulk-edit-select-all").attr("checked",!1);r.find(".bulk-edit-actions select").val("none");E(n,s)},g=function(e){var t=e.hasClass("allowed")?"allowed":"denied",n=t=="allowed"?"denied":"allowed",r=n=="allowed"?"Allow":"Deny";e.removeClass(t).addClass(n).text(r)},y=function(e){var t=e.data("post-type");b(e);e.bind("posts_loaded.buse",function(t,n){var r=e.data("perm-edits")||{allowed:[],denied:[]},i,s,o;for(i=0;i<r.allowed.length;i+=1){s=r.allowed[i];o=e.find("#p"+s);o.length&&x(o,!0,e)}for(i=0;i<r.denied.length;i+=1){s=r.denied[i];o=e.find("#p"+s);o.length&&x(o,!1,e)}});E(e,{post_type:t})},b=function(t){t.delegate("a","click",function(t){t.preventDefault();t.stopPropagation();var n=e(this).parent("li").first();n.siblings("li.perm-item-selected").each(function(){e(this).removeClass("perm-item-selected")});n.addClass("perm-item-selected")});t.bind("perm_updated",function(e,t){t.post.removeClass("perm-item-selected")})},w=function(n){var r={el:"#"+n.attr("id"),groupID:e("#group_id").val()||-1,postType:n.data("post-type")};e.extend(r,buse_perm_editor_settings);t.tree("buse_perm_editor",r);n.bind("load_node.jstree",function(e,t){t.rslt.obj!=-1&&N(t.rslt.obj)}).bind("perm_updated",function(e,t){var r=t.post;r.hasClass("jstree-closed")&&n.jstree("open_all",r);n.jstree("deselect_node",r)})},E=function(t,n){var r={action:"buse_render_post_list",group_id:e("#group_id").val()||-1,query:{}};typeof n!==undefined&&e.extend(r,n);t.addClass("loading");r.query.offset?t.append('<li class="loader">Loading...</li>'):t.html('<ul><li class="loader">Loading...</li></ul>');e.ajax({url:ajaxurl,type:"GET",data:r,cache:!1,success:function(e){r.query.offset?t.append(e.posts):t.html(e.posts);var n={page:e.page,found_posts:e.found_posts,post_count:e.post_count,max_num_pages:e.max_num_pages};S(n,t);t.trigger("posts_loaded.buse",{posts:e.posts});t.removeClass("loading")},error:function(e){}})},S=function(t,n){var r=n.data("post-type"),i=e("#group_id").val();$pagination=e("#perm-editor-pagination-"+r);$total_items=$pagination.find(".displaying-num");$current_page=$pagination.find(".current-page");$total_pages=$pagination.find(".total-pages");$first_page=$pagination.find(".first-page");$prev_page=$pagination.find(".prev-page");$next_page=$pagination.find(".next-page");$last_page=$pagination.find(".last-page");if(t.max_num_pages>1){var s=parseInt(t.found_posts)==1?" item":" items";$total_items.text(t.found_posts+s);$current_page.val(t.page);$total_pages.text(t.max_num_pages);if(t.page==1){$first_page.addClass("disabled");$prev_page.addClass("disabled")}else{$first_page.removeClass("disabled");$prev_page.removeClass("disabled")}if(t.page==t.max_num_pages){$next_page.addClass("disabled");$last_page.addClass("disabled")}else{$next_page.removeClass("disabled");$last_page.removeClass("disabled")}$pagination.show()}else $pagination.hide()},x=function(e,t,n){var r=n.data("post-type"),i=n.data("perm-edits")||{allowed:[],denied:[]},s;T(e,t,i);if(n.hasClass("hierarchical")){e.parent("ul").parent("div").attr("id")!=n.attr("id")?s=e.parents("li:last"):s=e;N(s)}n.data("perm-edits",i);k(r)},T=function(t,n,r){var i=t.attr("id").substr(1),s=t.find(".edit-perms").first();n!=t.data("editable")&&g(s);var o=n?"allowed":"denied",u=t.data("editable-original"),a;t.data("editable",n);t.attr("rel",o);if(u!=n){a=e.inArray(i,r[o]);a===-1&&r[o].push(i)}else{a=e.inArray(i,r.allowed);a>-1&&r.allowed.splice(a,1);a=e.inArray(i,r.denied);a>-1&&r.denied.splice(a,1)}var f=t.find("> ul > li");f.each(function(){T(e(this),n,r)})},N=function(t){$sections=t.find("ul");$sections.each(function(){var t=e(this).parents("li").first();if(t.length){var n=t.attr("rel"),r=!1;switch(n){case"allowed":case"allowed-desc-denied":case"allowed-desc-unknown":r=e(this).find('li[rel="denied"],li[rel="denied-desc-allowed"],li[rel="denied-desc-unknown"]').length;r?t.attr("rel","allowed-desc-denied"):t.attr("rel","allowed");C(t,r);break;case"denied":case"denied-desc-allowed":case"denied-desc-unknown":r=e(this).find('li[rel="allowed"],li[rel="allowed-desc-denied"],li[rel="allowed-desc-unknown"]').length;r?t.attr("rel","denied-desc-allowed"):t.attr("rel","denied");C(t,r)}}})},C=function(t,n){var r=t.find("> a > .perm-stats"),i,s=t.data("editable");if(r.length===0){r=e(' <span class="perm-stats"><ins class="jstree-icon">&nbsp;</ins><span class="label"></span></span>');t.find("> a > .title-count").after(r)}r.removeClass("allowed denied").children(".label").text("");n&&(s?r.addClass("denied").children(".label").text(n+" non-editable"):r.addClass("allowed").children(".label").text(n+" editable"))},k=function(t){var n=e("#"+t+"-stats"),r=e(".perm-stats-diff",n),i=e("#perm-editor-"+t).data("perm-edits");if(r.length===0){r=e('<span class="perm-stats-diff"></span>');n.append(r)}var s=[],o,u;for(o in i)if(i[o].length){u=o==="allowed"?"+":"-";s.push('<span class="'+o+'">'+u+i[o].length+"</span>")}var a=s.join(", ");a?r.html(" ("+a+")"):r.html("")},L=function(t,n,r){var i={classes:"error",before_msg:"<p>",after_msg:"</p>"};r&&typeof r=="object"&&e.extend(i,r);var s=n||"message",o=e("#"+s);o.attr("class",i.classes).html(i.before_msg+t+i.after_msg).fadeIn()},A=function(t){var n=t||"message";e("#"+n).fadeOut("fast",function(t){e(this).attr("class","").html("")})},O,M;O=e("#edit-group-name").val();var _=function(){var t=[];e("#group-member-list").children("li.member.active").each(function(n,r){t.push(e(r).children("input").first().val())});return t};M=_();window.onbeforeunload=function(){if(D())return"Your group has pending edits.  If you leave now, your changes will be lost."};var D=function(){var t=!1,n,r,i,s;n=e("#edit-group-name").val();O!=n&&(t=!0);r=_();if(M.length!=r.length)t=!0;else for(s=0;s<M.length;s+=1)e.inArray(M[s],r)==-1&&(t=!0);e(".perm-editor").each(function(){i=e(this).data("perm-edits");typeof i!="undefined"&&(i.allowed.length||i.denied.length)&&(t=!0)});return t};e("#group-edit-form").submit(function(t){window.onbeforeunload=null;var n=e.trim(e("#edit-group-name").val());if(n.length<1){L("Section editing groups require a name.");return!1}e(".perm-editor").each(function(){var t=e(this).data("perm-edits")||{allowed:[],denied:[]};e(this).siblings(".buse-edits").val(JSON.stringify(t))})});e("a.submitdelete").click(function(t){t.preventDefault();var n="You are about to permanently delete this section editing group.  This action is irreversible.\n\nAre you sure you want to do this?";if(confirm(n)){window.onbeforeunload=null;window.location=e(this).attr("href")}});if(document.images){var P=new Image,H=new Image;P.src=buse_group_editor_settings.pluginUrl+"/images/group_perms_sprite.png";H.src=buse_group_editor_settings.pluginUrl+"/images/loading.gif"}var B=e("#perm-panel-container").find(".perm-panel.active").first();B.length&&d(B);e("div#message").insertAfter(e("div.wrap h2:first"))});