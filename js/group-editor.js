if("undefined"===typeof bu||"undefined"===typeof bu.plugins.navigation||"undefined"===typeof bu.plugins.navigation.tree)throw new TypeError("BU Navigation Manager script dependencies have not been met!");
(function(a){var q=bu.plugins.navigation;q.trees.buse_perm_editor=function(m,j){var j=j||{},n=q.trees.base(m,j),e=n.data,g=a.extend(n.config,m||{}),l=n.$el,i=a.inArray("crrm",e.treeConfig.plugins);-1<i&&(e.treeConfig.plugins.splice(i,1),"undefined"!==typeof e.treeConfig.crrm&&delete e.treeConfig.crrm);i=a.inArray("dnd",e.treeConfig.plugins);-1<i&&(e.treeConfig.plugins.splice(i,1),"undefined"!==typeof e.treeConfig.dnd&&delete e.treeConfig.dnd);e.treeConfig.types={types:{"default":{icon:{image:g.pluginUrl+
"/images/group_perms_sprite.png",position:"-60px 0"}},denied:{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-60px 0"}},"denied-desc-allowed":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"2px 0"}},"denied-desc-unknown":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-100px 0"}},allowed:{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-40px 0"}},"allowed-desc-denied":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",
position:"-20px 0"}},"allowed-desc-unknown":{icon:{image:g.pluginUrl+"/images/group_perms_sprite.png",position:"-120px 0"}}}};e.treeConfig.ui={select_limit:1};e.treeConfig.json_data.ajax={url:g.rpcUrl,type:"GET",cache:!1,data:function(a){return{group_id:g.groupID,node_prefix:g.nodePrefix,post_type:g.postType,query:{child_of:a.attr?j.stripNodePrefix(a.attr("id")):0}}},success:function(a){return a.posts},error:function(){}};e.treeConfig.json_data.progressive_render=!1;var p=function(e){var e=!e||-1==
e?l.find("> ul > li"):a.jstree._reference(l)._get_node(e),g,i,k,j;e.each(function(){g=a(this);g.find("li").andSelf().each(function(){k=a(this).data("editable")?"denied":"allowed";j="allowed"==k?"Allow":"Deny";i=a('<button class="edit-perms '+k+'"></button>').text(j);a(this).children("a").not(":has(.edit-perms)").append(i)})})};l.bind("open_node.jstree create_node.jstree clean_node.jstree refresh.jstree",function(a,e){p(e.rslt.obj)});l.bind("loaded.jstree",function(){p()});return n}})(jQuery);
jQuery(document).ready(function(a){var q=bu.plugins.navigation,m=a("#group-member-list");a("a.nav-link").click(function(b){b.preventDefault();var b=a("a.nav-tab[href="+this.hash+"]"),c=a(this.hash);$input=c.hasClass("group-panel")?a("#tab"):a("#perm_panel");$input.val(b.data("target"));b.addClass("nav-tab-active").siblings().removeClass("nav-tab-active");c.addClass("active").siblings().removeClass("active")});a("#edit-group-name").blur(function(){var b=a.trim(a(this).val());60<b.length&&(b=b.slice(0,
59),a(this).val(b));if(1>b.length)return k("Section editing groups require a name."),!1;w();a("#group-stats-name").html(b)});a(".member:not(.active)").appendTo("#inactive-members");m.delegate("a.remove_member","click",function(b){b.preventDefault();a(this).parent(".member").removeClass("active").slideUp("fast",function(){a(this).appendTo("#inactive-members").find('input[type="checkbox"]').removeAttr("checked");g()})});var j=function(b){var c=a.map(a('li.member.active input[type="checkbox"]'),function(a){return a.value});
return-1<a.inArray(b.id,c)},n=a(".buse-suggest-user").autocomplete({source:function(b,c){var d,h=b.term;d=a.grep(buse_site_users,function(a){h=h.toLowerCase();return a.user.is_section_editor&&(-1!=a.user.display_name.toLowerCase().indexOf(h)||-1!=a.user.login.toLowerCase().indexOf(h)||-1!=a.user.nicename.toLowerCase().indexOf(h)||-1!=a.user.email.toLowerCase().indexOf(h))});d=a.grep(d,function(a){return!j(a.user)});d=a.map(d,function(a){return a.autocomplete});c(d)},delay:500,minLength:2,position:"undefined"!==
typeof isRtl&&isRtl?{my:"right top",at:"right bottom",offset:"0, -1"}:{offset:"0, -1"},open:function(){a(this).addClass("open")},close:function(){a(this).removeClass("open")}});a("#add_member").bind("click",function(a){a.preventDefault();e()});a("#user_login").keypress(function(a){"13"==a.keyCode&&(a.preventDefault(),e())});var e=function(){var b=a.trim(a("#user_login").val());if(b){n.autocomplete("search","");var c;c=a.grep(buse_site_users,function(a){var c=b.toLowerCase();return a.user.display_name.toLowerCase()==
c||a.user.login.toLowerCase()==c||a.user.nicename.toLowerCase()==c||a.user.email.toLowerCase()==c});c=1<c.length||0==c.length?!1:c[0].user;var d=buse_group_editor_settings.usersUrl;c?c.is_section_editor?j(c)?(c="<b>"+c.display_name+"</b> is already a member of this group.",k(c,"members-message")):(w("members-message"),a("#member_"+c.id).attr("checked","checked").parent(".member").addClass("active").appendTo(m).slideDown("fast"),g()):(d+="?s="+c.login,c="<b>"+c.display_name+'</b> is not a section editor.  Before you can assign them to a group, you must change their role to "Section Editor" on the <a href="'+
d+'">users page</a>.',k(c,"members-message")):(d=buse_group_editor_settings.userNewUrl,k("<b>"+b+'</b> is not a member of this site.  Please <a href="'+d+'">add them to your site</a> with the "Section Editor" role.',"members-message"))}a("#user_login").val("").focus()},g=function(){var b=m.children(".member").length;a(".member-count").html(b)},l=function(b){var c=b.find(".perm-editor").first();if(c.hasClass("hierarchical")){var d={el:"#"+c.attr("id"),groupID:a("#group_id").val()||-1,postType:c.data("post-type")};
a.extend(d,buse_group_editor_settings);q.tree("buse_perm_editor",d);c.bind("load_node.jstree",function(a,c){-1!=c.rslt.obj&&v(c.rslt.obj)}).bind("perm_updated",function(a,b){var d=b.post;d.hasClass("jstree-closed")&&c.jstree("open_all",d);c.jstree("deselect_node",d)})}else d=c.data("post-type"),c.delegate("a","click",function(h){h.preventDefault();h.stopPropagation();h=a(this).parent("li").first();h.siblings("li.perm-item-selected").each(function(){a(this).removeClass("perm-item-selected");c.trigger("deselect_post.buse",
{post:a(this)})});h.addClass("perm-item-selected");c.trigger("select_post.buse",{post:h})}),c.bind("perm_updated",function(a,c){c.post.removeClass("perm-item-selected")}),c.bind("posts_loaded.buse",function(){var a=c.data("perm-edits")||{allowed:[],denied:[]},b,d;for(b=0;b<a.allowed.length;b+=1)d=a.allowed[b],d=c.find("#p"+d),d.length&&r(d,!0,c);for(b=0;b<a.denied.length;b+=1)d=a.denied[b],d=c.find("#p"+d),d.length&&r(d,!1,c)}),p(c,{post_type:d});b.delegate("button.perm-search","click",function(b){b.preventDefault();
b=c.data("post-type");b=a("#perm-search-"+b).val();b={post_type:c.data("post-type"),query:{s:b}};p(c,b)});b.find(".pagination-links").delegate("a","click",function(b){b.preventDefault();if(!a(this).hasClass("disabled")){var b=a(this).attr("class"),d=parseInt(a(this).parent().find(".current-page").val()),f=parseInt(a(this).parent().find(".total-pages").text()),e=1;switch(b){case "first-page":e=1;break;case "prev-page":e=d-1;break;case "next-page":e=d+1;break;case "last-page":e=f}i(e,c)}});b.delegate("input.current-page",
"keypress",function(b){if("13"==b.keyCode){b.preventDefault();var b=a(this).val(),d=parseInt(a(this).parent().find(".total-pages").text());1>b?a(this).val(1):b>d&&a(this).val(d);b=a(this).val();i(b,c)}});b.delegate("input.perm-search","keypress",function(b){13==b.keyCode&&(b.preventDefault(),a(this).siblings("button").first().click())});b.delegate("a.perm-editor-bulk-edit","click",function(a){a.preventDefault();b.addClass("bulk-edit")});b.delegate("a.bulk-edit-close","click",function(a){a.preventDefault();
b.removeClass("bulk-edit")});b.delegate(".bulk-edit-select-all","click",function(){c.find('input[type="checkbox"]').attr("checked",this.checked)});b.delegate(".bulk-edit-actions button","click",function(d){d.preventDefault();var d=a(this).siblings("select"),e=d.val(),f=c.find('input[type="checkbox"]:checked');0<f.length&&("allowed"==e||"denied"==e)&&f.each(function(){var b=a(this).parents("li");r(b,"allowed"==e?!0:!1,c)});b.find(".bulk-edit-select-all").attr("checked",!1);d.val("none");f.attr("checked",
!1)});b.delegate("a.perm-tree-expand","click",function(b){b.preventDefault();a.jstree._reference(c).open_all()});b.delegate("a.perm-tree-collapse","click",function(b){b.preventDefault();a.jstree._reference(c).close_all()});c.delegate(".edit-perms","click",function(b){var d=a(b.currentTarget),f=d.closest("li"),d=d.attr("class"),e;b.stopPropagation();b.preventDefault();-1<d.indexOf("allowed")?e="allowed":-1<d.indexOf("denied")&&(e="denied");r(f,"allowed"==e?!0:!1,c);c.trigger("perm_updated",[{post:f,
action:e}])});a(document).bind("click",function(b){var c=a(".perm-panel.active"),d=a(".perm-editor",c);a.contains(c[0],b.target)||(d.hasClass("hierarchical")?d.jstree("deselect_all"):d.find(".perm-item-selected").removeClass("perm-item-selected"))});b.addClass("loaded")};a("#perm-tab-container").delegate("a","click",function(){var b=a(a(this).attr("href"));b.hasClass("loaded")||l(b)});var i=function(b,c){var d=c.closest(".perm-panel"),h=c.data("post-type"),e={post_type:h,query:{paged:b}},h=a("#perm-search-"+
h).val();0<h.length&&(e.query.s=h);d.find(".bulk-edit-select-all").attr("checked",!1);d.find(".bulk-edit-actions select").val("none");p(c,e)},p=function(b,c){var d={action:"buse_render_post_list",group_id:a("#group_id").val()||-1,query:{}};void 0!==typeof c&&a.extend(d,c);b.addClass("loading");d.query.offset?b.append('<span class="loader">Loading...</span>'):b.html('<span class="loader">Loading...</span>');a.ajax({url:ajaxurl,type:"GET",data:d,cache:!1,success:function(c){d.query.offset?b.append(c.posts):
b.html(c.posts);var e=c.page,f=c.found_posts,g=c.max_num_pages,i=b.data("post-type");a("#group_id").val();$pagination=a("#perm-editor-pagination-"+i);$total_items=$pagination.find(".displaying-num");$current_page=$pagination.find(".current-page");$total_pages=$pagination.find(".total-pages");$first_page=$pagination.find(".first-page");$prev_page=$pagination.find(".prev-page");$next_page=$pagination.find(".next-page");$last_page=$pagination.find(".last-page");i=1==parseInt(f)?" item":" items";$total_items.text(f+
i);$current_page.val(e);$total_pages.text(g);1==e?($first_page.addClass("disabled"),$prev_page.addClass("disabled")):($first_page.removeClass("disabled"),$prev_page.removeClass("disabled"));e==g?($next_page.addClass("disabled"),$last_page.addClass("disabled")):($next_page.removeClass("disabled"),$last_page.removeClass("disabled"));b.trigger("posts_loaded.buse",{posts:c.posts});b.removeClass("loading")},error:function(){}})},r=function(b,c,d){var e=d.data("post-type"),g=d.data("perm-edits")||{allowed:[],
denied:[]};u(b,c,g);d.hasClass("hierarchical")&&($root_post=b.parentsUntil("#"+d.attr("id"),"li").last(),$root_post.length&&v($root_post));d.data("perm-edits",g);c=a("#"+e+"-stats");b=a(".perm-stats-diff",c);e=a("#perm-editor-"+e).data("perm-edits");0===b.length&&(b=a('<span class="perm-stats-diff"></span>'),c.append(b));var c=[],f;for(f in e)e[f].length&&(d="allowed"===f?"+":"-",c.push('<span class="'+f+'">'+d+e[f].length+"</span>"));(f=c.join(", "))?b.html(" ("+f+")"):b.html("")},u=function(b,c,
d){var e=b.attr("id").substr(1),g=b.find(".edit-perms").first();if(c!=b.data("editable")){var f=g.hasClass("allowed")?"allowed":"denied",i="allowed"==f?"denied":"allowed";g.removeClass(f).addClass(i).text("allowed"==i?"Allow":"Deny")}g=c?"allowed":"denied";f=b.data("editable-original");b.data("editable",c);b.attr("rel",g);f!=c?(f=a.inArray(e,d[g]),-1===f&&d[g].push(e)):(f=a.inArray(e,d.allowed),-1<f&&d.allowed.splice(f,1),f=a.inArray(e,d.denied),-1<f&&d.denied.splice(f,1));b.find("> ul > li").each(function(){u(a(this),
c,d)})},v=function(b){$sections=b.find("ul");$sections.each(function(){var b=a(this).parents("li").first();if(b.length){var d=!1;switch(b.attr("rel")){case "allowed":case "allowed-desc-denied":case "allowed-desc-unknown":(d=0<a(this).find('li[rel="denied"],li[rel="denied-desc-allowed"],li[rel="denied-desc-unknown"]').length)?b.attr("rel","allowed-desc-denied"):b.attr("rel","allowed");break;case "denied":case "denied-desc-allowed":case "denied-desc-unknown":(d=0<a(this).find('li[rel="allowed"],li[rel="allowed-desc-denied"],li[rel="allowed-desc-unknown"]').length)?
b.attr("rel","denied-desc-allowed"):b.attr("rel","denied")}}})},k=function(b,c,d){var e={classes:"error",before_msg:"<p>",after_msg:"</p>"};d&&"object"==typeof d&&a.extend(e,d);a("#"+(c||"message")).attr("class",e.classes).html(e.before_msg+b+e.after_msg).fadeIn()},w=function(b){a("#"+(b||"message")).fadeOut("fast",function(){a(this).attr("class","").html("")})},x,s;x=a("#edit-group-name").val();var y=function(){var b=[];a("#group-member-list").children("li.member.active").each(function(c,d){b.push(a(d).children("input").first().val())});
return b};s=y();window.onbeforeunload=function(){var b=!1,c,d,e;c=a("#edit-group-name").val();x!=c&&(b=!0);c=y();if(s.length!=c.length)b=!0;else for(e=0;e<s.length;e+=1)-1==a.inArray(s[e],c)&&(b=!0);a(".perm-editor").each(function(){d=a(this).data("perm-edits");if("undefined"!==typeof d&&(d.allowed.length||d.denied.length))b=!0});if(b)return"Your group has pending edits.  If you leave now, your changes will be lost."};a("#group-edit-form").submit(function(){window.onbeforeunload=null;if(1>a.trim(a("#edit-group-name").val()).length)return k("Section editing groups require a name."),
!1;a(".perm-editor").each(function(){var b=a(this).data("perm-edits")||{allowed:[],denied:[]};a(this).siblings(".buse-edits").val(JSON.stringify(b))})});a("a.submitdelete").click(function(b){b.preventDefault();confirm("You are about to permanently delete this section editing group.  This action is irreversible.\n\nAre you sure you want to do this?")&&(window.onbeforeunload=null,window.location=a(this).attr("href"))});if(document.images){var t=new Image,z=new Image;t.src=buse_group_editor_settings.pluginUrl+
"/images/group_perms_sprite.png";z.src=buse_group_editor_settings.pluginUrl+"/images/loading.gif"}t=a("#perm-panel-container").find(".perm-panel.active").first();t.length&&l(t);a("div#message").insertAfter(a("div.wrap h2:first"))});