(function(b){if(!("undefined"===typeof bu||"undefined"===typeof bu.plugins.navigation||"undefined"===typeof bu.plugins.navigation.tree)){var n=bu.plugins.navigation;n.trees.buse_perm_editor=function(p,k){var k=k||{},q=n.trees.base(p,k),e=q.data,h=b.extend(q.config,p||{}),l=q.$el,i=b.inArray("crrm",e.treeConfig.plugins);-1<i&&(e.treeConfig.plugins.splice(i,1),"undefined"!==typeof e.treeConfig.crrm&&delete e.treeConfig.crrm);i=b.inArray("dnd",e.treeConfig.plugins);-1<i&&(e.treeConfig.plugins.splice(i,
1),"undefined"!==typeof e.treeConfig.dnd&&delete e.treeConfig.dnd);e.treeConfig.types={types:{"default":{},denied:{},"denied-desc-allowed":{},"denied-desc-unknown":{},allowed:{},"allowed-desc-denied":{},"allowed-desc-unknown":{}}};e.treeConfig.ui={select_limit:1};e.treeConfig.json_data.ajax={url:h.rpcUrl,type:"GET",cache:!1,data:function(b){return{group_id:h.groupID,node_prefix:h.nodePrefix,post_type:h.postType,query:{child_of:b.attr?k.stripNodePrefix(b.attr("id")):0}}},success:function(b){return b.posts},
error:function(){}};e.treeConfig.json_data.progressive_render=!1;var r=function(e){var e=!e||-1==e?l.find("> ul > li"):b.jstree._reference(l)._get_node(e),i,k,h,m;e.each(function(){i=b(this);i.find("li").andSelf().each(function(){h=b(this).data("editable")?"denied":"allowed";m="allowed"==h?"Allow":"Deny";k=b('<button class="edit-perms '+h+'"></button>').text(m);b(this).children("a").not(":has(.edit-perms)").append(k)})})};l.bind("open_node.jstree create_node.jstree clean_node.jstree refresh.jstree",
function(b,e){r(e.rslt.obj)});l.bind("loaded.jstree",function(){r()});l.addClass("buse-perm-editor");return q}}})(jQuery);
jQuery(document).ready(function(b){var n;"undefined"!==typeof bu&&("undefined"!==typeof bu.plugins.navigation&&"undefined"!==typeof bu.plugins.navigation.tree)&&(n=bu.plugins.navigation);var p=b("#group-member-list");b("a.nav-link").click(function(a){a.preventDefault();var a=b("a.nav-tab[href="+this.hash+"]"),c=b(this.hash);$input=c.hasClass("group-panel")?b("#tab"):b("#perm_panel");$input.val(a.data("target"));a.addClass("nav-tab-active").siblings().removeClass("nav-tab-active");c.addClass("active").siblings().removeClass("active")});
b("#edit-group-name").blur(function(){var a=b.trim(b(this).val());60<a.length&&(a=a.slice(0,59),b(this).val(a));if(1>a.length)return m("Section editing groups require a name."),!1;y();b("#group-stats-name").html(a)});b(".member:not(.active)").appendTo("#inactive-members");p.delegate("a.remove_member","click",function(a){a.preventDefault();b(this).parent(".member").removeClass("active").slideUp("fast",function(){b(this).appendTo("#inactive-members").find('input[type="checkbox"]').removeAttr("checked");
h()})});var k=function(a){var c=b.map(b('li.member.active input[type="checkbox"]'),function(b){return b.value});return-1<b.inArray(a.id,c)},q=b(".buse-suggest-user").autocomplete({source:function(a,c){var d,j=a.term;d=b.grep(buse_site_users,function(b){j=j.toLowerCase();return b.user.is_section_editor&&(-1!=b.user.display_name.toLowerCase().indexOf(j)||-1!=b.user.login.toLowerCase().indexOf(j)||-1!=b.user.nicename.toLowerCase().indexOf(j)||-1!=b.user.email.toLowerCase().indexOf(j))});d=b.grep(d,function(b){return!k(b.user)});
d=b.map(d,function(b){return b.autocomplete});c(d)},delay:500,minLength:2,position:"undefined"!==typeof isRtl&&isRtl?{my:"right top",at:"right bottom",offset:"0, -1"}:{offset:"0, -1"},open:function(){b(this).addClass("open")},close:function(){b(this).removeClass("open")}});b("#add_member").bind("click",function(b){b.preventDefault();e()});b("#user_login").keypress(function(b){"13"==b.keyCode&&(b.preventDefault(),e())});var e=function(){var a=b.trim(b("#user_login").val());if(a){q.autocomplete("search",
"");var c;c=b.grep(buse_site_users,function(b){var c=a.toLowerCase();return b.user.display_name.toLowerCase()==c||b.user.login.toLowerCase()==c||b.user.nicename.toLowerCase()==c||b.user.email.toLowerCase()==c});c=1<c.length||0==c.length?!1:c[0].user;var d=buse_group_editor_settings.usersUrl;c?c.is_section_editor?k(c)?(c="<b>"+c.display_name+"</b> is already a member of this group.",m(c,"members-message")):(y("members-message"),b("#member_"+c.id).attr("checked","checked").parent(".member").addClass("active").appendTo(p).slideDown("fast"),
h()):(d+="?s="+c.login,c="<b>"+c.display_name+'</b> is not a section editor.  Before you can assign them to a group, you must change their role to "Section Editor" on the <a href="'+d+'">users page</a>.',m(c,"members-message")):(d=buse_group_editor_settings.userNewUrl,m("<b>"+a+'</b> is not a member of this site.  Please <a href="'+d+'">add them to your site</a> with the "Section Editor" role.',"members-message"))}b("#user_login").val("").focus()},h=function(){var a=p.children(".member").length;b(".member-count").html(a)},
l=function(a){var c=a.find(".perm-editor").first();if(c.hasClass("hierarchical"))if("undefined"===typeof n)alert("Warning: Hierarchical permissions editor require the BU Navigation plugin."),c.text("Please install the BU Navigation plugin in order to set permissions for post type: "+c.data("post-type"));else{var d={el:"#"+c.attr("id"),groupID:b("#group_id").val()||-1,postType:c.data("post-type")};b.extend(d,buse_group_editor_settings);n.tree("buse_perm_editor",d);c.bind("load_node.jstree",function(b,
c){-1!=c.rslt.obj&&w(c.rslt.obj)}).bind("perm_updated",function(b,a){var d=a.post;d.hasClass("jstree-closed")&&c.jstree("open_all",d);c.jstree("deselect_node",d)})}else d=c.data("post-type"),c.delegate("a","click",function(c){c.preventDefault();c.stopPropagation();c=b(this).parent("li").first();c.siblings("li.perm-item-selected").each(function(){b(this).removeClass("perm-item-selected")});c.addClass("perm-item-selected")}),c.bind("perm_updated",function(b,c){c.post.removeClass("perm-item-selected")}),
c.bind("posts_loaded.buse",function(){var b=c.data("perm-edits")||{allowed:[],denied:[]},a,d;for(a=0;a<b.allowed.length;a+=1)d=b.allowed[a],d=c.find("#p"+d),d.length&&s(d,!0,c);for(a=0;a<b.denied.length;a+=1)d=b.denied[a],d=c.find("#p"+d),d.length&&s(d,!1,c)}),r(c,{post_type:d});a.delegate("button.perm-search","click",function(a){a.preventDefault();a=c.data("post-type");a=b("#perm-search-"+a).val();a={post_type:c.data("post-type"),query:{s:a}};r(c,a)});a.find(".pagination-links").delegate("a","click",
function(a){a.preventDefault();if(!b(this).hasClass("disabled")){var a=b(this).attr("class"),d=parseInt(b(this).parent().find(".current-page").val()),f=parseInt(b(this).parent().find(".total-pages").text()),e=1;switch(a){case "first-page":e=1;break;case "prev-page":e=d-1;break;case "next-page":e=d+1;break;case "last-page":e=f}i(e,c)}});a.delegate("input.current-page","keypress",function(a){if("13"==a.keyCode){a.preventDefault();var a=b(this).val(),d=parseInt(b(this).parent().find(".total-pages").text());
1>a?b(this).val(1):a>d&&b(this).val(d);a=b(this).val();i(a,c)}});a.delegate("input.perm-search","keypress",function(a){13==a.keyCode&&(a.preventDefault(),b(this).siblings("button").first().click())});a.delegate("a.perm-editor-bulk-edit","click",function(d){d.preventDefault();d=b(this);a.hasClass("bulk-edit")?(d.removeClass("bulk-edit-close").attr("title","Enable bulk edit mode").text("Bulk Edit"),a.removeClass("bulk-edit")):(d.addClass("bulk-edit-close").attr("title","Disable bulk edit mode").text("Close Bulk Edit"),
a.addClass("bulk-edit"));c.find(".perm-item-selected").removeClass("perm-item-selected");a.find('input[type="checkbox"]').attr("checked",!1);b(".bulk-edit-actions select").val("none")});a.delegate(".bulk-edit-select-all","click",function(){c.find("li").children('input[type="checkbox"]').attr("checked",this.checked)});a.delegate(".bulk-edit-actions button","click",function(d){d.preventDefault();var d=b(this).siblings("select"),g=d.val(),f=c.find('input[type="checkbox"]:checked');0<f.length&&("allowed"==
g||"denied"==g)&&f.each(function(){var a=b(this).parents("li");s(a,"allowed"==g?!0:!1,c)});a.find(".bulk-edit-select-all").attr("checked",!1);d.val("none");f.attr("checked",!1)});a.delegate("a.perm-tree-expand","click",function(a){a.preventDefault();b.jstree._reference(c).open_all()});a.delegate("a.perm-tree-collapse","click",function(a){a.preventDefault();b.jstree._reference(c).close_all()});c.delegate(".edit-perms","click",function(a){var d=b(a.currentTarget),f=d.closest("li"),d=d.attr("class"),
e;a.stopPropagation();a.preventDefault();-1<d.indexOf("allowed")?e="allowed":-1<d.indexOf("denied")&&(e="denied");s(f,"allowed"==e?!0:!1,c);c.trigger("perm_updated",[{post:f,action:e}])});b(document).bind("click",function(a){var c=b(".perm-panel.active"),d=b(".perm-editor",c);b.contains(c[0],a.target)||(d.hasClass("hierarchical")?d.jstree("deselect_all"):d.find(".perm-item-selected").removeClass("perm-item-selected"))});a.addClass("loaded")};b("#perm-tab-container").delegate("a","click",function(){var a=
b(b(this).attr("href"));a.hasClass("loaded")||l(a)});var i=function(a,c){var d=c.closest(".perm-panel"),j=c.data("post-type"),e={post_type:j,query:{paged:a}},j=b("#perm-search-"+j).val();0<j.length&&(e.query.s=j);d.find(".bulk-edit-select-all").attr("checked",!1);d.find(".bulk-edit-actions select").val("none");r(c,e)},r=function(a,c){var d={action:"buse_render_post_list",group_id:b("#group_id").val()||-1,query:{}};void 0!==typeof c&&b.extend(d,c);a.addClass("loading");d.query.offset?a.append('<span class="loader">Loading...</span>'):
a.html('<span class="loader">Loading...</span>');b.ajax({url:ajaxurl,type:"GET",data:d,cache:!1,success:function(c){d.query.offset?a.append(c.posts):a.html(c.posts);var e=c.page,f=c.found_posts,h=c.max_num_pages,i=a.data("post-type");b("#group_id").val();$pagination=b("#perm-editor-pagination-"+i);$total_items=$pagination.find(".displaying-num");$current_page=$pagination.find(".current-page");$total_pages=$pagination.find(".total-pages");$first_page=$pagination.find(".first-page");$prev_page=$pagination.find(".prev-page");
$next_page=$pagination.find(".next-page");$last_page=$pagination.find(".last-page");1<h?(i=1==parseInt(f)?" item":" items",$total_items.text(f+i),$current_page.val(e),$total_pages.text(h),1==e?($first_page.addClass("disabled"),$prev_page.addClass("disabled")):($first_page.removeClass("disabled"),$prev_page.removeClass("disabled")),e==h?($next_page.addClass("disabled"),$last_page.addClass("disabled")):($next_page.removeClass("disabled"),$last_page.removeClass("disabled")),$pagination.show()):$pagination.hide();
a.trigger("posts_loaded.buse",{posts:c.posts});a.removeClass("loading")},error:function(){}})},s=function(a,c,d){var e=d.data("post-type"),g=d.data("perm-edits")||{allowed:[],denied:[]};v(a,c,g);d.hasClass("hierarchical")&&(a=a.parent("ul").parent("div").attr("id")!=d.attr("id")?a.parents("li:last"):a,w(a));d.data("perm-edits",g);g=b("#"+e+"-stats");d=b(".perm-stats-diff",g);e=b("#perm-editor-"+e).data("perm-edits");0===d.length&&(d=b('<span class="perm-stats-diff"></span>'),g.append(d));var g=[],
f;for(f in e)e[f].length&&(a="allowed"===f?"+":"-",g.push('<span class="'+f+'">'+a+e[f].length+"</span>"));(f=g.join(", "))?d.html(" ("+f+")"):d.html("")},v=function(a,c,d){var e=a.attr("id").substr(1),g=a.find(".edit-perms").first();if(c!=a.data("editable")){var f=g.hasClass("allowed")?"allowed":"denied",h="allowed"==f?"denied":"allowed";g.removeClass(f).addClass(h).text("allowed"==h?"Allow":"Deny")}g=c?"allowed":"denied";f=a.data("editable-original");a.data("editable",c);a.attr("rel",g);f!=c?(f=
b.inArray(e,d[g]),-1===f&&d[g].push(e)):(f=b.inArray(e,d.allowed),-1<f&&d.allowed.splice(f,1),f=b.inArray(e,d.denied),-1<f&&d.denied.splice(f,1));a.find("> ul > li").each(function(){v(b(this),c,d)})},w=function(a){$sections=a.find("ul");$sections.each(function(){var a=b(this).parents("li").first();if(a.length){var d=!1;switch(a.attr("rel")){case "allowed":case "allowed-desc-denied":case "allowed-desc-unknown":(d=b(this).find('li[rel="denied"],li[rel="denied-desc-allowed"],li[rel="denied-desc-unknown"]').length)?
a.attr("rel","allowed-desc-denied"):a.attr("rel","allowed");x(a,d);break;case "denied":case "denied-desc-allowed":case "denied-desc-unknown":(d=b(this).find('li[rel="allowed"],li[rel="allowed-desc-denied"],li[rel="allowed-desc-unknown"]').length)?a.attr("rel","denied-desc-allowed"):a.attr("rel","denied"),x(a,d)}}})},x=function(a,c){var d=a.find("> a > .perm-stats"),e=a.data("editable");0===d.length&&(d=b(' <span class="perm-stats"><ins class="jstree-icon">&nbsp;</ins><span class="label"></span></span>'),
a.find("> a > .title-count").after(d));d.removeClass("allowed denied").children(".label").text("");c&&(e?d.addClass("denied").children(".label").text(c+" non-editable"):d.addClass("allowed").children(".label").text(c+" editable"))},m=function(a,c,d){var e={classes:"error",before_msg:"<p>",after_msg:"</p>"};d&&"object"==typeof d&&b.extend(e,d);b("#"+(c||"message")).attr("class",e.classes).html(e.before_msg+a+e.after_msg).fadeIn()},y=function(a){b("#"+(a||"message")).fadeOut("fast",function(){b(this).attr("class",
"").html("")})},z,t;z=b("#edit-group-name").val();var A=function(){var a=[];b("#group-member-list").children("li.member.active").each(function(c,d){a.push(b(d).children("input").first().val())});return a};t=A();window.onbeforeunload=function(){var a=!1,c,d,e;c=b("#edit-group-name").val();z!=c&&(a=!0);c=A();if(t.length!=c.length)a=!0;else for(e=0;e<t.length;e+=1)-1==b.inArray(t[e],c)&&(a=!0);b(".perm-editor").each(function(){d=b(this).data("perm-edits");if("undefined"!==typeof d&&(d.allowed.length||
d.denied.length))a=!0});if(a)return"Your group has pending edits.  If you leave now, your changes will be lost."};b("#group-edit-form").submit(function(){window.onbeforeunload=null;if(1>b.trim(b("#edit-group-name").val()).length)return m("Section editing groups require a name."),!1;b(".perm-editor").each(function(){var a=b(this).data("perm-edits")||{allowed:[],denied:[]};b(this).siblings(".buse-edits").val(JSON.stringify(a))})});b("a.submitdelete").click(function(a){a.preventDefault();confirm("You are about to permanently delete this section editing group.  This action is irreversible.\n\nAre you sure you want to do this?")&&
(window.onbeforeunload=null,window.location=b(this).attr("href"))});if(document.images){var u=new Image,B=new Image;u.src=buse_group_editor_settings.pluginUrl+"/images/group_perms_sprite.png";B.src=buse_group_editor_settings.pluginUrl+"/images/loading.gif"}u=b("#perm-panel-container").find(".perm-panel.active").first();u.length&&l(u);b("div#message").insertAfter(b("div.wrap h2:first"))});